<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Raster Data Pt 2: Common Raster Manipulations" />
  <meta name="copyright" content="<span class='footer-right'><a href='../acknowledgements.html'>Acknowledgements</a></span><span class='footer-right'><a href='../index.html'>Course Homepage</a></span><span class='footer-right'>Forum:&nbsp<a href=' https://tinyurl.com/rspatial-scgis19 ' target='_blank'> https://tinyurl.com/rspatial-scgis19 </a></span><span class='footer-subtitle'> Spatial Data Analysis with R </span>"/>
  <meta name="font-size-adjustment" content="2"/>
  <title>Spatial Data Analysis with R  SCGIS Conference, 2019</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACkUlEQVQ4jX2SW0jTcRTHTzNyeZlh6lqmm3POdNPC6SxSEzaqafkykOFoIxTDWpKRFV6iQMNLFyMSsQvUW0WORc2WWBmGKEGZXUyz0NrmNmfa1PYgfHsQ1v5oHjgvX875/M45vy/R8mDJ9caxrFIL5CUWJB00Q9n+7Q+l1BetUMuMTL3JpTB0QVnejd1Hu9DQ60G5eQbqB7PIvj0L2bUZ0KZzghWbs0o7Fx3Tc/B6vStm6+g0wrQvIKh2gKKyUxnNSZoO685SC1YDeL1e9Ll+Ia7WCd5pJ4hojQ8g1nViezETYBqZx93BOdwa9jAgsdUT4J6ZQqC6f4GIiLYU9/RzNWYIdU9hd/8rLjN7UGT8DbWROVVMlQsBBWas142DiIikdfbFMF0POIVm2NzM1zwLS+mvcSsnEajpBSv/8RIgucGJ1EYXEs+NwjrlWfUGMee/Y2PFJIJLrFibex8kOsahhCYnUlpnIL1kh9X9/yMKG2yIOOlAsPYnAveZsE75EEQUQLwTwy5Rsxvx9UxApKEPEYY+BiSizA623oaggkdgq4xLKwRLq7i8sy6EFlpg8wNEVwyAd3wAbZ8cPu3CazeCC/sRojYjaL8Jvm8MPWLDBm03A8CveQ9+7RBia4cYU4QfeokwzTOwc6/4OzKXHap/C5ufD0RNo0i4OAZR81dcnnD69Mp3PxBe9GRkuZdFKk7sqTcQ132EpGUMydetSLnpgOSGHVtbxpHU9AX8mkFEG55/ZrjQL1h82V6esPLVh8Sr40i940J6xzzS7s1C0m6HqHEEiTnatgT5gcPijHxltFwhjpRIQpZjBAJ2lFTBFW5TiOPT8mXx6apdcRl5OaJM1Q6hLC9ls3RPTLgok0NELCKiv02kPqt/O1MZAAAAAElFTkSuQmCC" rel="icon" type="image/x-icon" />
  <script language="javascript" type="text/javascript">
  function TriShowHide(shID) {
    shIDspan = shID + "span";
    shIDdiv = shID + "div";
    if (document.getElementById(shIDdiv).style.display != 'block') {
      document.getElementById(shIDdiv).style.display = 'block';
      txtSpan = "&#9660;";
    } else {
      document.getElementById(shIDdiv).style.display = 'none';
      txtSpan = "&#9654;";
    }
    document.getElementById(shIDspan).innerHTML = txtSpan + " ";
  }
  function showHide(shID) {
    if (shID=="soln-show-all") {
      var allAnswerCode = document.getElementsByClassName("answer-code");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'block';
      }
    } else if (shID=="soln-hide-all") {
      var allAnswerCode = document.getElementsByClassName("answer-code");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'none';
      }
    } else if (shID=="hints-show-all") {
      var allAnswerCode = document.getElementsByClassName("hint");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'block';
      }
    } else if (shID=="hints-hide-all") {
      var allAnswerCode = document.getElementsByClassName("hint");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'none';
      }
    } else {
      if (document.getElementById(shID)) {
        if (document.getElementById(shID).style.display != 'block') {
          document.getElementById(shID).style.display = 'block';
        } else {
          document.getElementById(shID).style.display = 'none';
        }
      }
    }
  }
  function CopyToClipboard(containerid) {
  if (document.selection) {
      var range = document.body.createTextRange();
      range.moveToElementText(document.getElementById(containerid));
      range.select().createTextRange();
      document.execCommand("copy");
  } else if (window.getSelection) {
      var range = document.createRange();
      range.selectNode(document.getElementById(containerid));
      window.getSelection().addRange(range);
      document.execCommand("copy");
      // alert("text copied")
  }}
  </script>
  <link href="lib/slidy-2/styles/slidy.css" rel="stylesheet" />
  <script src="lib/slidy-2/scripts/slidy.js"></script>
  <script src="lib/clipboard-1.7.1/clipboard.min.js"></script>
  <link href="lib/primer-tooltips-1.4.0/build.css" rel="stylesheet" />
  <link href="lib/klippy-0.0.0.9500/css/klippy.min.css" rel="stylesheet" />
  <script src="lib/klippy-0.0.0.9500/js/klippy.min.js"></script>
  <script src="lib/kePrint-0.0.1/kePrint.js"></script>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
   href="..\css\slidy_styles.css" />
  <meta name="duration" content="0" />
</head>
<body>
<div class="slide titlepage">
  <h1 class="title"><span class="course-title">Spatial Data Analysis with R </span><br/><span class="course-subtitle">SCGIS Conference, 2019</span></h1>
  <p class="author">
Raster Data Pt 2: Common Raster Manipulations <br/><img src='images/zonal_stats256_366x220.png'/>
  </p>
</div>
<div id="viewing-raster-properties" class="slide section level1">
<h1>Viewing <tt>Raster*</tt> properties</h1>
<script language="javascript" type="text/javascript">w3c_slidy.mouse_click_enabled = false;</script>
<script>
  addKlippy('left', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<p>A number of functions are available to view the properties of a raster object. Most of these are read-only.</p>
<table class="tbl_compact">
<thead>
<tr>
<th style="text-align:left;">
Property
</th>
<th style="text-align:left;">
Function(s)
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
image dimensions
</td>
<td style="text-align:left;font-family: monospace;">
nrow(), ncol(), ncell(), dim()
</td>
</tr>
<tr>
<td style="text-align:left;">
resolution (pixel size)
</td>
<td style="text-align:left;font-family: monospace;">
res()
</td>
</tr>
<tr>
<td style="text-align:left;">
number of layers
</td>
<td style="text-align:left;font-family: monospace;">
nlayers(), nbands()
</td>
</tr>
<tr>
<td style="text-align:left;">
layer names
</td>
<td style="text-align:left;font-family: monospace;">
names()
</td>
</tr>
<tr>
<td style="text-align:left;">
coordinate reference system
</td>
<td style="text-align:left;font-family: monospace;">
proj4string(), projection()
</td>
</tr>
<tr>
<td style="text-align:left;">
extent
</td>
<td style="text-align:left;font-family: monospace;">
extent()
</td>
</tr>
<tr>
<td style="text-align:left;">
in memory or not
</td>
<td style="text-align:left;font-family: monospace;">
inMemory()
</td>
</tr>
<tr>
<td style="text-align:left;">
source file
</td>
<td style="text-align:left;font-family: monospace;">
filename()
</td>
</tr>
<tr>
<td style="text-align:left;">
has values
</td>
<td style="text-align:left;font-family: monospace;">
hasValues()
</td>
</tr>
<tr>
<td style="text-align:left;">
cell values data type
</td>
<td style="text-align:left;font-family: monospace;">
dataType()
</td>
</tr>
<tr>
<td style="text-align:left;">
has a raster attribute table
</td>
<td style="text-align:left;font-family: monospace;">
is.factor()
</td>
</tr>
</tbody>
</table>
<div class="tryit">
<p>Try some of the above functions on the DEM you imported previously.</p>
</div>
</div>
<div id="raster-data-manipulations" class="slide section level1">
<h1>Raster Data Manipulations</h1>
<p>Common raster manipulations include:</p>
<table class="tbl_compact">
<thead>
<tr>
<th style="text-align:left;">
Task
</th>
<th style="text-align:left;">
Function(s)
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
visualize
</td>
<td style="text-align:left;font-family: monospace;">
image(), plot()
</td>
</tr>
<tr>
<td style="text-align:left;">
(re)project
</td>
<td style="text-align:left;font-family: monospace;">
projectRaster()
</td>
</tr>
<tr>
<td style="text-align:left;">
crop
</td>
<td style="text-align:left;font-family: monospace;">
crop()
</td>
</tr>
<tr>
<td style="text-align:left;">
mask
</td>
<td style="text-align:left;font-family: monospace;">
mask()
</td>
</tr>
<tr>
<td style="text-align:left;">
resample (i.e., change the pixel size)
</td>
<td style="text-align:left;font-family: monospace;">
aggregate(), resample()
</td>
</tr>
<tr>
<td style="text-align:left;">
adjust pixel values (stretch, reclassify, etc.)
</td>
<td style="text-align:left;font-family: monospace;">
getValues(), rst[], setValues()
</td>
</tr>
<tr>
<td style="text-align:left;">
stack
</td>
<td style="text-align:left;font-family: monospace;">
stack()
</td>
</tr>
<tr>
<td style="text-align:left;">
mosaic
</td>
<td style="text-align:left;font-family: monospace;">
mosaic()
</td>
</tr>
<tr>
<td style="text-align:left;">
vector –&gt; raster
</td>
<td style="text-align:left;font-family: monospace;">
rasterize()
</td>
</tr>
<tr>
<td style="text-align:left;">
export to disk
</td>
<td style="text-align:left;font-family: monospace;">
writeRaster(), writeGDAL()
</td>
</tr>
</tbody>
</table>
<div class="preview">
<p>In future a section, we’ll look at some raster analytical functions such as:</p>
<table class="tbl_compact">
<thead>
<tr>
<th style="text-align:left;">
Task
</th>
<th style="text-align:left;">
Function(s)
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
descriptive cell statistics
</td>
<td style="text-align:left;font-family: monospace;">
cellStats()
</td>
</tr>
<tr>
<td style="text-align:left;">
binary mask
</td>
<td style="text-align:left;font-family: monospace;">
myrast[]
</td>
</tr>
<tr>
<td style="text-align:left;">
raster algebra (local operations)
</td>
<td style="text-align:left;font-family: monospace;">
* + - /
</td>
</tr>
<tr>
<td style="text-align:left;">
focal (neighborhood) operations
</td>
<td style="text-align:left;font-family: monospace;">
focal()
</td>
</tr>
<tr>
<td style="text-align:left;">
zonal stats
</td>
<td style="text-align:left;font-family: monospace;">
zonal()
</td>
</tr>
<tr>
<td style="text-align:left;">
distance surface
</td>
<td style="text-align:left;font-family: monospace;">
distance()
</td>
</tr>
<tr>
<td style="text-align:left;">
spatial join (enrichment)
</td>
<td style="text-align:left;font-family: monospace;">
extract()
</td>
</tr>
<tr>
<td style="text-align:left;">
spatial interpolation
</td>
<td style="text-align:left;font-family: monospace;">
</td>
</tr>
<tr>
<td style="text-align:left;">
classify pixels
</td>
<td style="text-align:left;font-family: monospace;">
</td>
</tr>
<tr>
<td style="text-align:left;">
time series analysis
</td>
<td style="text-align:left;font-family: monospace;">
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="projecting-rasters" class="slide section level1">
<h1>Projecting Rasters</h1>
<p>Like <tt>sf</tt> objects, projection info in rasters is saved. You can view (or assign) a CRS to a raster object using <tt>proj4string()</tt>.</p>
<p><strong>Projecting rasters</strong> on the other hand is a little more complicated than vector features because of the additional spatial structure implicit in the grid. If you blindly apply a projection equation to cell coordinates, you’ll very likely wind up with <strong>non-square</strong> cells. <strong>That’s a problem</strong> if your goal is to combine the projected raster with other rastesrs for analysis or visualization, because the cells may not align properly.</p>
<h2 id="projectraster"><tt>projectRaster()</tt></h2>
<p>To help with this, the <tt>projectRaster()</tt> function has some <strong>additional arguments</strong>:</p>
<div class="indented2">
<p><tt>projectRaster(from, to, res, crs, method, alignOnly=FALSE, filename="")</tt></p>
</div>
<p>If you’re trying to project a raster to <strong>match another one</strong>, you can simply enter the existing one as the <tt><strong>to</strong></tt> argument and R will match the cell size and extent. You can also manually specify the resolution with <tt><strong>res</strong></tt>.</p>
<p><tt><strong>method</strong></tt> - determines how the projected cell values will be computed. <em>Very important</em> to pay attention:</p>
<div class="indented2">
<p><strong>categorical rasters</strong> - pixel values are merely integrates that correspond to a category, let <tt><strong>method=‘ngb’</strong></tt> (nearest neighbor) so the output cell values remain integers.</p>
<p><strong>continous rasters</strong> - use <strong>bilinear</strong> to interpolate new values.</p>
</div>
<h3 id="example-project-elevation-data-from-lat-long-to-utm">Example: Project Elevation Data from Lat-Long to UTM</h3>
<p>Let’s project the Yosemite DEM to UTM.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">yose_dem_ll</a>
<a class="sourceLine" id="cb1-2" title="2">yose_dem_utm &lt;-<span class="st"> </span><span class="kw">projectRaster</span>(yose_dem_ll, <span class="dt">to=</span>sfpen_elev, <span class="dt">method=</span><span class="st">&quot;ngb&quot;</span>)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">plot</span>(sfpen_elev, <span class="dt">legend=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">plotRGB</span>(sfpen_<span class="dv">1869</span>_utm, <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">alpha=</span><span class="dv">128</span>)</a></code></pre></div>
<h2 id="working-with-extent-objects">Working with Extent objects</h2>
<p>The extent of a Raster is simply the rectangular area it reflects, like a bounding box. Extent objects can saved on their own and used for cropping, creating new raster objects, etc. You can increase an Extent object on all sides using <tt>raster::extend()</tt>, and even project it with <tt>raster::projectExtent()</tt>. The former offers an easy way to enlarge the area is cropped to have a little buffer on all sides.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">sf_big_ext &lt;-<span class="st"> </span><span class="kw">extend</span>(<span class="kw">extent</span>(sfbnd_utm), <span class="dv">1000</span>)    <span class="co"># use map units</span></a>
<a class="sourceLine" id="cb2-2" title="2">sfcity_dem_buff &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">crop</span>(sfpen_elev, sf_big_ext)</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">plot</span>(sfcity_dem_buff)</a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">plot</span>(sfbnd_utm, <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">col=</span><span class="ot">NA</span>, <span class="dt">border=</span><span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</a></code></pre></div>
</div>
<div id="masking" class="slide section level1">
<h1>Masking</h1>
<p>Masking is similar to cropping, but rather than chopping off rows and columns, pixels that fall outside the study area are simply set to <tt>NA</tt>. This allows you to perform raster analyses for irregular areas, because most statistical functions ignore <tt>NA</tt> values, and R will generally make <tt>NA</tt> pixels transparent when plotting.</p>
<p>To mask a raster, use <tt>raster::mask(<em>rst</em>, <em>mask</em>)</tt> where <em>rst</em> is your raster and <em>mask</em> is an another Raster or Spatial object (e.g., polygon).</p>
<h2 id="mask-example">Mask Example</h2>
<p>Mask the San Francisco DEM to the city limits.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">sfcity_msk_dem &lt;-<span class="st"> </span><span class="kw">mask</span>(sfcity_dem, sfbnd_utm)</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">plot</span>(sfcity_msk_dem)</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">plot</span>(sfbnd_utm, <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">col=</span><span class="ot">NA</span>, <span class="dt">border=</span><span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</a></code></pre></div>
</div>
<div id="stacking-rasters" class="slide section level1">
<h1>Stacking Rasters</h1>
<p><tt>RasterStack</tt> and <tt>RasterBrick</tt> objects store multi-layer rasters. When you import a multi-layer raster from disk using the <tt>raster::brick()</tt> function, you get a <tt>RasterBrick</tt> object. However sometimes your source data come from different files. In this case, feed the filenames into the <tt>raster::stack()</tt> function.</p>
<p>Example: Importing Multiple TIF Files into <tt>RasterStack</tt></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="co">## Find tif files (should all be in the same CRS)</span></a>
<a class="sourceLine" id="cb4-2" title="2">data_dir &lt;-<span class="st"> &quot;../docs/data&quot;</span></a>
<a class="sourceLine" id="cb4-3" title="3">tiffs &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path=</span>data_dir, <span class="dt">pattern=</span><span class="st">&quot;^m(.*)tif$&quot;</span>)</a>
<a class="sourceLine" id="cb4-4" title="4">tiffs</a>
<a class="sourceLine" id="cb4-5" title="5"></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="co">## Add the path</span></a>
<a class="sourceLine" id="cb4-7" title="7">tiffs_fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(data_dir, tiffs)</a>
<a class="sourceLine" id="cb4-8" title="8"><span class="kw">head</span>(tiffs_fn)</a>
<a class="sourceLine" id="cb4-9" title="9"><span class="kw">file.exists</span>(tiffs_fn)</a>
<a class="sourceLine" id="cb4-10" title="10"></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="co">## Import the files as a stack</span></a>
<a class="sourceLine" id="cb4-12" title="12">big_stack &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">stack</span>(tiffs_fn)</a>
<a class="sourceLine" id="cb4-13" title="13">big_stack</a>
<a class="sourceLine" id="cb4-14" title="14"></a>
<a class="sourceLine" id="cb4-15" title="15"><span class="co">## Plot layers one by one</span></a>
<a class="sourceLine" id="cb4-16" title="16"><span class="kw">plot</span>(big_stack, <span class="dt">legend=</span><span class="ot">FALSE</span>)</a></code></pre></div>
<div class="tip">
<p>If you want to plot a multi-layered raster as a RGB image, use <tt>plotRGB()</tt> and use the <tt>r</tt>, <tt>g</tt>, and <tt>b</tt> arguments to indicate which layers to use as red, green and blue.</p>
</div>
<h2 id="working-with-multi-layer-rasters">Working with Multi-Layer Rasters</h2>
<p>Most functions like cropping and masking will work on all layers combined.</p>
<p>You can grab a single layer the same way you would a list, such as <tt>big_stack[[1]]</tt> or <tt>big_stack$<em>layer_name</em></tt>. To pull out multiple layers, use <tt>raster::subset()</tt>.</p>
<p>Add and delete layers with <tt>raster::addLayer()</tt> and <tt>raster::dropLayer()</tt>.</p>
<div class="tryit">
<p>Import the <em>mission_tempXX.tif</em> files in the data folder as a <tt>RasterStack</tt>.</p>
</div>
<p>See also: <a href="http://rspatial.org/rs/rst/2-exploration.html#view-image-properties" target="_blank">Remote Sensing Image Analysis</a> by Robert Hijmans</p>
</div>
<div id="changing-the-resolution-pixel-size" class="slide section level1">
<h1>Changing the Resolution (Pixel Size)</h1>
<p>You may want to change the pixel size to reduce the amount of data and therefore computation time required. Another common case is where you need to match the resolution of two rasters so you can do pixel-by-pixel computations.</p>
<p>The raster package has two functions to change pixel size:</p>
<div class="indented4">
<p><tt>aggregate(x, fact=2, fun=mean, …)</tt></p>
<p><tt>resample(x, y, method=“bilinear”, …)</tt></p>
</div>
<p>Use <tt>aggregate()</tt> when you want to increase pixel size by a numeric factor, for example by 2 (twice as big). The <tt>fun</tt> agrument allows you to specify the function uses to summarize values (e.g., take the mean). <tt>resample()</tt> will match the pixel size of another raster. Remeber with discrete or categorical data, use <tt>method=‘ngb’</tt> so the cell values in the output will remain integers.</p>
<h2 id="example-resample-a-dem-with-aggregate">Example: Resample a DEM with aggregate()</h2>
<p>Let’s reduce the resolution of the DEM by a factor of 15. Note the discernably larger pixel sizes.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">sfcity_msk_dem_150m &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">aggregate</span>(sfcity_msk_dem, <span class="dt">fact=</span><span class="dv">15</span>)</a>
<a class="sourceLine" id="cb5-2" title="2">sfcity_msk_dem_150m</a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">plot</span>(sfcity_msk_dem_150m)</a>
<a class="sourceLine" id="cb5-4" title="4"><span class="kw">plot</span>(sfbnd_utm, <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">col=</span><span class="ot">NA</span>, <span class="dt">border=</span><span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</a></code></pre></div>
</div>
<div id="slope-aspect-and-hill-shade" class="slide section level1">
<h1>Slope, Aspect, and Hill Shade</h1>
<p>A slope surface is a raster whose cell values represent the slope of the terrain, while an aspect raster records the direction of the compass is uphill. Both of these can be created from a DEM with the raster package’s <tt>terrain()</tt> function.</p>
<p>You can feed slope and aspect rasters into the <tt>hillShade()</tt> function to generate a raster the simulates shading.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">sfpen_slope &lt;-<span class="st"> </span><span class="kw">terrain</span>(sfpen_elev, <span class="dt">opt=</span><span class="st">&quot;slope&quot;</span>)</a>
<a class="sourceLine" id="cb6-2" title="2">sfpen_aspect &lt;-<span class="st"> </span><span class="kw">terrain</span>(sfpen_elev, <span class="dt">opt=</span><span class="st">&quot;aspect&quot;</span>)</a>
<a class="sourceLine" id="cb6-3" title="3">sfpen_hillshade &lt;-<span class="st"> </span><span class="kw">hillShade</span>(sfpen_slope, sfpen_aspect, <span class="dv">40</span>,<span class="dv">270</span>)</a>
<a class="sourceLine" id="cb6-4" title="4"><span class="kw">plot</span>(sfpen_hillshade, <span class="dt">col=</span><span class="kw">grey</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">100</span><span class="op">/</span><span class="dv">100</span>), <span class="dt">legend=</span><span class="ot">FALSE</span>)</a></code></pre></div>
<div class="tryit">
<p>Create a hillshade for San Francisco.</p>
<p>What do the two numeric arguments in the <tt>hillShade()</tt> function do?</p>
</div>
</div>
<div id="rasterize-vector-features" class="slide section level1">
<h1>Rasterize Vector Features</h1>
<p>Occassionally you have to convert vector features to a raster format for an analysis. Points, lines and polygons can all be converted to raster with the <tt>rasterize()</tt> function. Details you have to think about are what cell size to use, what the values of the cells should be, and what to do when two vector features overlap or fall in the same cell.</p>
<div class="indented4">
<p><tt>rasterize(<em>sp_object</em>, <em>rast</em>, <em>field</em>, <em>fun=‘last’</em>, <em>background=NA</em>, <em>mask=FALSE</em>)</tt></p>
</div>
<p>Typically, you use another raster (i.e., the one you’re trying to match) as the ‘template’ for the rasterized features, passed as <tt>rast</tt> (must have the same CRS). The <tt>field</tt> argument has a number of options for the cell output values, including a constant value, or the name of a column in the vector attribute table.</p>
<h2 id="example-rasterize-sf-neighborhoods">Example: Rasterize SF neighborhoods</h2>
<p>Rasterize the SF neighborhoods, using the DEM as the raster template.</p>
<p>First load the neighborhood boundaries, and project them to match the raster.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">library</span>(rgdal)</a>
<a class="sourceLine" id="cb7-2" title="2">sfnb_ll &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="st">&quot;../docs/data&quot;</span>, <span class="st">&quot;sf_neighborhoods&quot;</span>)</a>
<a class="sourceLine" id="cb7-3" title="3">sfnb_prj &lt;-<span class="st"> </span><span class="kw">spTransform</span>(sfnb_ll, <span class="kw">proj4string</span>(sfcity_msk_dem))</a>
<a class="sourceLine" id="cb7-4" title="4"><span class="kw">plot</span>(sfnb_prj, <span class="dt">col=</span><span class="kw">topo.colors</span>(<span class="kw">nrow</span>(sfnb_prj)), <span class="dt">axes=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<p>Next, we rasterize.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">sfnb_rst &lt;-<span class="st"> </span><span class="kw">rasterize</span>(sfnb_prj, sfcity_msk_dem)</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">plot</span>(sfnb_rst, <span class="dt">col=</span><span class="kw">topo.colors</span>(<span class="kw">nrow</span>(sfnb_prj)), <span class="dt">legend=</span><span class="ot">FALSE</span>)</a></code></pre></div>
</div>
<div id="working-with-categorical-rasters" class="slide section level1">
<h1>Working with Categorical Rasters</h1>
<p>We just created a categorical raster where the cell values are integers that refer to a category. We can see the frequency of cell values as a matrix with <tt>freq()</tt>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">freq</span>(sfnb_rst)</a></code></pre></div>
<p>To save the category labels as part of our raster, we need to give it a “Raster Attribute Table” (RAT). The <tt>ratify()</tt> function will return a categorical (factor) raster with a bare bones RAT that we can then add columns to.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">sfnb_rstcat &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">ratify</span>(sfnb_rst)</a>
<a class="sourceLine" id="cb10-2" title="2">sfnb_rstcat</a></code></pre></div>
<p>We can grab the RAT with <tt>levels()</tt>. Note that the RAT is simply a data frame, but <tt>levels()</tt> returns a <em><strong>list</strong></em> of data frames (one for each layer).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">str</span>(<span class="kw">levels</span>(sfnb_rstcat))</a></code></pre></div>
<p>We can add columns to the RAT data frame the same way add columns to any data frame. Let’s add the neighborhood names to the RAT, which can get from the attribute table of the vector layer.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">levels</span>(sfnb_rstcat)[[<span class="dv">1</span>]]<span class="op">$</span>nhood &lt;-<span class="st"> </span>sfnb_prj<span class="op">@</span>data<span class="op">$</span>nhood</a></code></pre></div>
<p>To plot the raster with the neighborhood names in the legend, we have to turn to the rasterVis package which has the <tt>levelplot()</tt> function. We also need to come up with a large number of random colors.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">library</span>(rasterVis)</a>
<a class="sourceLine" id="cb13-2" title="2">many_colors &lt;-<span class="st"> </span>grDevices<span class="op">::</span><span class="kw">colors</span>()[<span class="kw">grep</span>(<span class="st">&#39;gr(a|e)y&#39;</span>, grDevices<span class="op">::</span><span class="kw">colors</span>(), <span class="dt">invert =</span> T)]</a>
<a class="sourceLine" id="cb13-3" title="3">nb_colors &lt;-<span class="st"> </span><span class="kw">sample</span>(many_colors, <span class="kw">nrow</span>(<span class="kw">levels</span>(sfnb_rstcat)[[<span class="dv">1</span>]]))</a>
<a class="sourceLine" id="cb13-4" title="4">rasterVis<span class="op">::</span><span class="kw">levelplot</span>(sfnb_rstcat, <span class="dt">colorkey=</span><span class="kw">list</span>(<span class="dt">height=</span><span class="dv">1</span>), <span class="dt">col.regions=</span>nb_colors, <span class="dt">xlab=</span><span class="st">&quot;&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;&quot;</span>)</a></code></pre></div>
</div>
<div id="rescale-and-reclassify" class="slide section level1">
<h1>Rescale and Reclassify</h1>
<p>Other common manipulations of raster data leave the spatial structure intact, but modify the cell values. For example you may want to ‘clip’ the values so that all values below a certain threshhold are changed to ‘0’. Another example would be a linear stretch for better visualization.</p>
<h2 id="working-with-cell-values">Working with Cell Values</h2>
<p>We’ve already seen you can visualize the distribution of cell values with the <tt>hist()</tt> function.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">hist</span>(sfcity_msk_dem, <span class="dt">col=</span><span class="st">&quot;grey50&quot;</span>)</a></code></pre></div>
<p>There are couple of ways to <em>get</em> cell values so you can analyze them or feed them into a statistical model.</p>
<div class="indented2">
<p><tt><strong>getValues()</strong></tt> - returns a copy of all pixel values as a vector (useful for global operations)</p>
<p><tt><strong>getValuesBlock()</strong></tt> - returns a copy of a rectangular block of cell values</p>
</div>
<p>To both read and write (edit) cell values, you can use square brackets. Like data frames, you can add an expression for the rows and columns to work with.</p>
<div class="indented2">
<p><tt><strong>myrast[]</strong>, <strong>myrast[<em>rows</em>, <em>cols</em>]</strong></tt></p>
</div>
<div class="tip">
<p>By default, the <strong>myrast[]</strong> notation will return cell values as a numeric vector. If you want to return select columns and rows as a Raster object, add <tt>drop=FALSE</tt>.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">sfcity_msk_dem[<span class="dv">500</span><span class="op">:</span><span class="dv">501</span>, <span class="dv">450</span><span class="op">:</span><span class="dv">451</span>, drop=<span class="ot">FALSE</span>]</a></code></pre></div>
</div>
<p>Another function you can use to change cell values is <tt><strong>setValues()</strong></tt>. Note however that <tt><strong>setValues()</strong></tt> requires you to pass a numeric vector for all cells, whereas square bracket notation (e.g, <strong>myrast[<em>expr</em>]</strong>) allow you to assign new values to only those cells that meet a condition in <em>expr</em>.</p>
<h2 id="example-zero-out-small-values">Example: Zero-out small values</h2>
<p>In the following example, we identify pixel values that are below a threshhold, and then set them to 0.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">dem_copy &lt;-<span class="st"> </span>sfcity_msk_dem</a>
<a class="sourceLine" id="cb16-2" title="2">dem_vals &lt;-<span class="st"> </span><span class="kw">getValues</span>(dem_copy)</a>
<a class="sourceLine" id="cb16-3" title="3">small_vals &lt;-<span class="st"> </span>(dem_vals <span class="op">&lt;</span><span class="st"> </span><span class="dv">50</span>)   <span class="co">## Create a Boolean vector</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="kw">table</span>(small_vals)</a>
<a class="sourceLine" id="cb16-5" title="5">dem_copy[small_vals] &lt;-<span class="st"> </span><span class="dv">0</span></a></code></pre></div>
<p>Compare results</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb17-2" title="2">x &lt;-<span class="st"> </span><span class="kw">hist</span>(sfcity_msk_dem, <span class="dt">col=</span><span class="st">&quot;grey50&quot;</span>, <span class="dt">main=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">Original&quot;</span>)</a>
<a class="sourceLine" id="cb17-3" title="3"><span class="kw">hist</span>(dem_copy, <span class="dt">col=</span><span class="st">&quot;grey50&quot;</span>, <span class="dt">breaks=</span>x<span class="op">$</span>breaks, <span class="dt">main=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">Small Vals Zeroed&quot;</span>)</a></code></pre></div>
<div class="tryit">
<p>Create a copy of the DEM where all small values are i) turned to zero, ii) changed to <tt>NA</tt>.</p>
<p>How many cells got zeroed out? How much area do they represent?</p>
</div>
<div class="tip">
<p>Functions that return a <em>copy</em> of a raster with modified cell values are <tt>calc()</tt> and <tt>reclassify()</tt>.</p>
<p>The example above could be created with</p>
<pre><code>zero_if_small &lt;- function(x) { x[x&lt;50] &lt;- 0; return(x) }
dem_zeroed &lt;- calc(sfcity_msk_dem, zero_if_small)</code></pre>
</div>
<h2 id="reclassify">Reclassify</h2>
<p>Reclassifying changes groups of cell values to other values all at once. For example, you could change all cell values between 1 and 10 to become 1, all values between 11 and 15 become 2, etc.</p>
<p>The <tt>reclassify()</tt> function makes this easy by allowing you to pass a 3-column matrix with columns for the lower bound, upper bound, and new value for each group.</p>
<h2 id="example-reclassify-a-dem-into-low-medium-and-high">Example: Reclassify a DEM into Low, Medium, and High</h2>
<p>Step 1. Create the reclassification matrix. The first and second columns should define the range of input values, and the third column should be the new value in the output. Rows should be mutually exclusive.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">rcl_mat &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">1</span>,<span class="dv">20</span>,<span class="dv">100</span>,<span class="dv">2</span>,<span class="dv">100</span>,<span class="dv">500</span>,<span class="dv">3</span>), <span class="dt">ncol=</span><span class="dv">3</span>, <span class="dt">byrow=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb19-2" title="2">rcl_mat</a></code></pre></div>
<p>Step 2. Apply the reclassifcation matrix. If you need to fine-tune whether the lower and upper bounds are open or closed, see the help page.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">sfcity_dem_recls &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">reclassify</span>(sfcity_msk_dem, rcl_mat)</a>
<a class="sourceLine" id="cb20-2" title="2">sfcity_dem_recls</a>
<a class="sourceLine" id="cb20-3" title="3"><span class="kw">freq</span>(sfcity_dem_recls)</a></code></pre></div>
<p>View results.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="kw">plot</span>(sfcity_dem_recls, <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;cyan&quot;</span>, <span class="st">&quot;green4&quot;</span>, <span class="st">&quot;tan&quot;</span>))</a></code></pre></div>
<div class="tryit">
<p>Use <tt>reclassify()</tt> to identify areas in San Francisco at risk of flooding from sea level rise.</p>
</div>
</div>
<div id="dealing-with-missing-data" class="slide section level1">
<h1>Dealing with Missing Data</h1>
<p>Remotely sensed raster data often have pixels around the edges that are ‘missing’ values because the sensor didn’t record that area. Other times, an analyst may chose to manually ‘erase’ pixel values outside a non-rectangular study areas so those pixels are omitted from analyses.</p>
<p>There are a variety of conventions for flagging ‘missing’ data depending on the file format. Sometimes they are simply recorded as ‘0’, but that doesn’t always work because 0 can also mean no reflectance. Other common values for <tt>NoData</tt> are -9999 or -3.4e+38 for floating point rasters. R uses <tt>NA</tt> to signify missing data, which most statistical functions ignore and most plotting functions make transparent.</p>
<div class="tryit">
<p>TIF files can have a tag in the header which records the value used for ‘NoData’. You can see this with the GDALinfo() function.</p>
<pre><code>rgdal::GDALinfo(&quot;../docs/data/sf_elev_utm10n.tif&quot;)</code></pre>
</div>
</div>
<div id="exporting-a-raster" class="slide section level1">
<h1>Exporting a Raster</h1>
<p>The <tt>raster</tt> package has its own export function, <tt>writeRaster()</tt>, that can export a raster to a number of common file formats including GeoTIFF, ENVI, IDRISI, netCDF, ERDAS, and others. You can of course also export using <tt>writeGDAL()</tt> from the <tt>rgdal</tt> package.</p>
<h2 id="example-writeraster">Example: writeRaster()</h2>
<p>Save the San Francisco neighborhoods raster in netCDF format:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1"><span class="kw">writeRaster</span>(sfnb_rst, <span class="dt">filename=</span><span class="st">&quot;sf_neighborhoods.nc&quot;</span>, <span class="dt">format=</span><span class="st">&quot;CDF&quot;</span>)</a></code></pre></div>
</div>
<div id="summary" class="slide section level1">
<h1>Summary</h1>
<p>Today we saw how to:</p>
<div class="compact">
<ul>
<li>view a raster’s properties</li>
<li>project a raster</li>
<li>mask a master to a polygon</li>
<li>resample</li>
<li>stretch &amp; rescale values,</li>
<li>stack</li>
<li>rasterize vectors</li>
<li>export</li>
</ul>
</div>
<div class="infobox">
<p>Additional Resources</p>
<div class="indented1">
<ul>
<li><a href="https://datacarpentry.org/r-raster-vector-geospatial/01-raster-structure/" target="_blank">Intro to Raster Data in R</a>, DataCarpentry</li>
</ul>
</div>
</div>
<p>
<strong>Next: </strong> <a href="12_raster3-analysis.html">Raster Pt III. Raster Analysis Functions</a>
</p>
</div>

  <!-- dynamically load mathjax for compatibility with self-contained -->
  <script>
    (function () {
      var script = document.createElement("script");
      script.type = "text/javascript";
      script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
      document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>

</body>
</html>
