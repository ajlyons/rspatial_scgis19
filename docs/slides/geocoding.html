<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Geocoding" />
  <meta name="copyright" content="<span class='footer-right'><a href='../acknowledgements.html'>Acknowledgements</a></span><span class='footer-right'><a href='../index.html'>Course Homepage</a></span><span class='footer-right'>Forum:&nbsp<a href=' https://tinyurl.com/rspatial-scgis19 ' target='_blank'> https://tinyurl.com/rspatial-scgis19 </a></span><span class='footer-subtitle'> Spatial Data Analysis with R </span>"/>
  <meta name="font-size-adjustment" content="2"/>
  <title>Spatial Data Analysis with R</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACkUlEQVQ4jX2SW0jTcRTHTzNyeZlh6lqmm3POdNPC6SxSEzaqafkykOFoIxTDWpKRFV6iQMNLFyMSsQvUW0WORc2WWBmGKEGZXUyz0NrmNmfa1PYgfHsQ1v5oHjgvX875/M45vy/R8mDJ9caxrFIL5CUWJB00Q9n+7Q+l1BetUMuMTL3JpTB0QVnejd1Hu9DQ60G5eQbqB7PIvj0L2bUZ0KZzghWbs0o7Fx3Tc/B6vStm6+g0wrQvIKh2gKKyUxnNSZoO685SC1YDeL1e9Ll+Ia7WCd5pJ4hojQ8g1nViezETYBqZx93BOdwa9jAgsdUT4J6ZQqC6f4GIiLYU9/RzNWYIdU9hd/8rLjN7UGT8DbWROVVMlQsBBWas142DiIikdfbFMF0POIVm2NzM1zwLS+mvcSsnEajpBSv/8RIgucGJ1EYXEs+NwjrlWfUGMee/Y2PFJIJLrFibex8kOsahhCYnUlpnIL1kh9X9/yMKG2yIOOlAsPYnAveZsE75EEQUQLwTwy5Rsxvx9UxApKEPEYY+BiSizA623oaggkdgq4xLKwRLq7i8sy6EFlpg8wNEVwyAd3wAbZ8cPu3CazeCC/sRojYjaL8Jvm8MPWLDBm03A8CveQ9+7RBia4cYU4QfeokwzTOwc6/4OzKXHap/C5ufD0RNo0i4OAZR81dcnnD69Mp3PxBe9GRkuZdFKk7sqTcQ132EpGUMydetSLnpgOSGHVtbxpHU9AX8mkFEG55/ZrjQL1h82V6esPLVh8Sr40i940J6xzzS7s1C0m6HqHEEiTnatgT5gcPijHxltFwhjpRIQpZjBAJ2lFTBFW5TiOPT8mXx6apdcRl5OaJM1Q6hLC9ls3RPTLgok0NELCKiv02kPqt/O1MZAAAAAElFTkSuQmCC" rel="icon" type="image/x-icon" />
  <script language="javascript" type="text/javascript">
  function TriShowHide(shID) {
    shIDspan = shID + "span";
    shIDdiv = shID + "div";
    if (document.getElementById(shIDdiv).style.display != 'block') {
      document.getElementById(shIDdiv).style.display = 'block';
      txtSpan = "&#9660;";
    } else {
      document.getElementById(shIDdiv).style.display = 'none';
      txtSpan = "&#9654;";
    }
    document.getElementById(shIDspan).innerHTML = txtSpan + " ";
  }
  function showHide(shID) {
    if (shID=="soln-show-all") {
      var allAnswerCode = document.getElementsByClassName("answer-code");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'block';
      }
    } else if (shID=="soln-hide-all") {
      var allAnswerCode = document.getElementsByClassName("answer-code");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'none';
      }
    } else if (shID=="hints-show-all") {
      var allAnswerCode = document.getElementsByClassName("hint");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'block';
      }
    } else if (shID=="hints-hide-all") {
      var allAnswerCode = document.getElementsByClassName("hint");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'none';
      }
    } else {
      if (document.getElementById(shID)) {
        if (document.getElementById(shID).style.display != 'block') {
          document.getElementById(shID).style.display = 'block';
        } else {
          document.getElementById(shID).style.display = 'none';
        }
      }
    }
  }
  function CopyToClipboard(containerid) {
  if (document.selection) {
      var range = document.body.createTextRange();
      range.moveToElementText(document.getElementById(containerid));
      range.select().createTextRange();
      document.execCommand("copy");
  } else if (window.getSelection) {
      var range = document.createRange();
      range.selectNode(document.getElementById(containerid));
      window.getSelection().addRange(range);
      document.execCommand("copy");
      // alert("text copied")
  }}
  </script>
  <link href="lib/slidy-2/styles/slidy.css" rel="stylesheet" />
  <script src="lib/slidy-2/scripts/slidy.js"></script>
  <script src="lib/kePrint-0.0.1/kePrint.js"></script>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
   href="..\css\slidy_styles.css" />
  <meta name="duration" content="0" />
</head>
<body>
<div class="slide titlepage">
  <h1 class="title"><span class="course-subtitle">Spatial Data Analysis with R</span></h1>
  <p class="author">
<span class="pres-title">Geocoding</span>
  </p>
</div>
<div id="geocoding" class="slide section level1">
<h1>Geocoding</h1>
<script type="text/javascript">w3c_slidy.mouse_click_enabled = false;</script>
<p>Geocoding is the process of turning an address or place name into latitude-longitude coordinates.</p>
<p><img src="images/geocoding_500x422.png" class="indented4" /></p>
<h2 id="things-you-can-geocode">Things You Can Geocode</h2>
<div class="indented2">
<ul>
<li>street addresses or intersectiones</li>
<li>named places (e.g., “Miami”)</li>
<li>country, state, city, building</li>
<li>named landmarks (e.g., Mt. Everest)</li>
<li>zip codes</li>
</ul>
</div>
<h2 id="why-geocode">Why Geocode?</h2>
<div class="indented2">
<ul>
<li>to display locations on a map</li>
<li>link data by location (e.g., census tract, distance to <em>x</em>)</li>
<li>spatial analysis
<ul>
<li>calculate distance, direction, area, etc.</li>
<li>identify clusters, outliers, neighbors</li>
</ul></li>
</ul>
</div>
<h2 id="geocoding-elements">Geocoding Elements</h2>
<ol style="list-style-type: decimal">
<li>Input locations
<ul>
<li>places of the same type in a standard format</li>
</ul></li>
<li>Geocoding Service
<ul>
<li>Software + reference database</li>
<li>The software compares input locations to database &amp; returns matches</li>
<li>Typically on a server</li>
</ul></li>
<li>Output
<ul>
<li>Geographic coordinates for each matched input location</li>
<li>Metadata about the match</li>
</ul></li>
</ol>
</div>
<div id="geocoding-services" class="slide section level1">
<h1>Geocoding Services</h1>
<h2 id="browser-based">Browser Based</h2>
<div class="indented2">
<ul>
<li><p><a href="http://maps.google.com" target="_blank">Google Maps</a></p></li>
<li><p><a href="https://geocoding.geo.census.gov/" target="_blank">US Census Geocoding Tool</a></p></li>
<li><p><a href="http://www.arcgis.com" target="_blank">ArcGIS Online</a></p></li>
</ul>
</div>
<h2 id="apis---free-public">APIs - Free / Public</h2>
<div class="indented2">
<ul>
<li><p><a href="https://wiki.openstreetmap.org/wiki/Nominatim" target="_blank">Open Street Map Nominatim</a></p></li>
<li><p><a href="https://developer.mapquest.com/documentation/open/nominatim-search/" target="_blank">Mapquest Open</a></p></li>
<li><p><a href="https://geocoding.geo.census.gov/geocoder/Geocoding_Services_API.pdf" target="_blank">US Census Geocoding API</a></p></li>
</ul>
</div>
<h2 id="apis---commercial-and-freemium">APIs - Commercial and Freemium</h2>
<div class="indented2">
<ul>
<li><p><a href="https://developers.google.com/maps/documentation/geocoding/start" target="_blank">Google Maps Geocode API</a></p></li>
<li><p><a href="https://developers.arcgis.com/rest/geocode/" target="_blank">ESRI World Geocoding Service API</a></p></li>
</ul>
</div>
<p><a href="https://docs.google.com/spreadsheets/d/1I2rEVX2CN8AqkhpzUTuNwNvJy8il1exccrsd4OGwDCU/edit#gid=0" target="_blank">Many others here</a>!</p>
<p>Free services generally limit # addresses per search, # queries per second, and/or # queries per day</p>
<p>Paid and freemium API services usually require getting a key, agreeing to the Terms of Service, and linking it to a billing account (credit card)</p>
<h2 id="recommendations">Recommendations</h2>
<p>One-time need plus modest number of address queries?<br />
Use a browser interface</p>
<p>If you need an API, look at:</p>
<ol style="list-style-type: decimal">
<li>ESRI WGS (if you have access)</li>
<li>OSM Nominatim (if there’s good results for your area)</li>
<li>Google Geocode API</li>
</ol>
</div>
<div id="getting-a-google-maps-api-key" class="slide section level1">
<h1>Getting a Google Maps API Key</h1>
<p><strong>Billing Enabled required!</strong> As of mid-2018, Google requires you to link your API key to a billing account (e.g., connected to a credit card). According to them, this helps ensure actual people are getting keys, and provides them a way to bill customers who use Google API services heavily.</p>
<p>The documentation states you will automatically get $200/month worth of API services (enough for about 40,000 Gecode queries, minus other services you use). You may also get a $300 credit for the first year.</p>
<p>This highlights the importance of <strong>protecting your API key</strong> (see below).</p>
<h2 id="getting-your-api-key">Getting Your API Key</h2>
<p>Instructions adapted from <em><a href="https://developers.google.com/maps/documentation/geocoding/get-api-key" target="_blank">Getting a Geocoding API Key</a></em></p>
<ol style="list-style-type: decimal">
<li><p>Log into Google with the account you want to use</p></li>
<li><p>Go to the <a href="https://console.cloud.google.com/google/maps-apis" target="_blank">Google Cloud Platform Console</a></p></li>
<li><p>From the Project drop-down menu, select or create the project for which you want to add an API key.</p></li>
<li><p>From the Navigation Menu, select <em>API and Services</em> &gt;&gt; <em>Library</em>. Search for “Geocoding API” and enable it for the project.</p></li>
<li><p>From the Navigation menu, select <em>APIs &amp; Services</em> &gt;&gt; <em>Credentials</em>.</p></li>
<li><p>On the Credentials page, click <em>Create credentials</em> &gt;&gt; <em>API ke</em>y. Your key is created and displayed immediately.</p></li>
<li><p>On the same page, click <em>Restrictions</em> &gt;&gt; <em>API Restrictions</em>. Restrict your API to just Geocoding API. Now if someone steals it, at least they can only use it for geocoding. Of course if you want to use the same key for downloading background tiles or other services, enable those APIs as well.</p></li>
</ol>
<p>For additional info, see the <a href="https://developers.google.com/maps/documentation/geocoding/start" target="_blank">Google Geocoding API Documentation</a></p>
</div>
<div id="protecting-your-api-key" class="slide section level1">
<h1>Protecting your API Key</h1>
<p>API keys are like passwords that provide access to services that you could be billed for. However unlike passwords, API keys are often transmitted unencrypted from web pages and scripts like R or Python. Careless developers will even hardcode their API key in their HTML code or R script, making it very easy to discover.</p>
<p>There are two things you can do to protect your API key.</p>
<h2 id="restrict-its-use-and-period-of-validity">1. Restrict its Use and Period of Validity</h2>
<p>When you create a Google API key, you can limit it to specific APIs (e.g., only good for downloading background tiles), and/or application (e.g. only works from a specific website with a specific IP address).</p>
<p>Some services (e.g., ESRI Geocoding Service, see below) also impose expiration dates on API keys.</p>
<h2 id="dont-put-the-api-key-in-code">2. Don’t Put the API Key in Code</h2>
<p>Although it’s very convenient to simply paste your API in your code, anyone who sees your script will be able to see and potentially use your key.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="co">## Don&#39;t do this!!</span></a>
<a class="sourceLine" id="cb1-2" title="2">myKey &lt;-<span class="st"> &quot;R5p7S006$7K#v3V7UYncAq^lUVxBN7@-`c5p@Cg&#39;#jFzoO</span><span class="ch">\?</span><span class="st">l+o5Q&quot;</span></a></code></pre></div>
<p>A better technique is to store your key in a file somewhere where it won’t be accidentally shared. Then you import it into your script. It is still unencrypted in memory, so this is still not very secure, but at least it won’t be accidentially shared.</p>
<p>The following commands will read the first line of a text file like the one shown below, and save the results to a variable.</p>
<div class="centerblock">
<img src="images/api_text-file.png" />
</div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">api_fn &lt;-<span class="st"> &quot;~/my-google-geocode-api.txt&quot;</span>  <span class="co">## File located in &#39;home&#39; folder (My Documents)</span></a>
<a class="sourceLine" id="cb2-2" title="2">f &lt;-<span class="st"> </span><span class="kw">file</span>(api_fn, <span class="dt">open =</span> <span class="st">&quot;rt&quot;</span>)   <span class="co">## create a (file) connection object</span></a>
<a class="sourceLine" id="cb2-3" title="3">mykey_google &lt;-<span class="st"> </span><span class="kw">readLines</span>(f, <span class="dt">n=</span><span class="dv">1</span>)       <span class="co">## n=1 read first line only </span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">close</span>(f)</a>
<a class="sourceLine" id="cb2-5" title="5">mykey_google</a></code></pre></div>
<pre><code>## [1] &quot;R5p7S006$7K#v3V7UYncAq^lUVxBN7@-`c5p@Cg&#39;#jFG:3V/*G&#39;9fYk*ktj~?1*zz,B.YcD?rx8ABZz80&quot;</code></pre>
<p>You can also save your API key as a *.RData file with the <tt>save()</tt> function, the same way you would save any R object, and bring it back into R with <tt>load()</tt>.</p>
<p>For additional tips, see also: <a href="https://developers.google.com/maps/api-key-best-practices" target="_blank">API Key Best Practices</a>.</p>
</div>
<div id="geocoding-with-google-using-ggmap" class="slide section level1">
<h1>Geocoding with Google using <tt>ggmap</tt></h1>
<h2 id="ggmap-package"><tt>ggmap</tt> package</h2>
<p><tt>ggmap</tt> is a popular package that people use for:</p>
<div class="indented2">
<ul>
<li>geocoding</li>
<li>making nice looking static maps (covered in another lesson)</li>
</ul>
</div>
<h2 id="supported-geocoders">Supported Geocoders</h2>
<p><em>ggmap</em> works with the following <em>online</em> geocoding services:</p>
<div class="compact">
<ul>
<li>Google Maps API
<ul>
<li>as of July 2018 you need to generate an API key and associate it with a credit card</li>
<li><a href="https://developers.google.com/maps/documentation/geocoding/start" target="_blank">More info</a></li>
<li>no daily limits</li>
</ul></li>
<li>Data Science Toolkit - <span style="color:red;"><em>service no longer available</em></span>
<ul>
<li>draws from US Census and OpenStreetMap</li>
<li>available as Vagrant VM or EC2 AMI (i.e., you can install it yourself)</li>
</ul></li>
</ul>
</div>
<div class="info">
<p>Use <tt>ggmap</tt> version 2.7.900 or later, it has better features for protecting your API keys. You can check which version you have by running:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">packageVersion</span>(<span class="st">&quot;ggmap&quot;</span>)</a></code></pre></div>
<p>If the version on <a href="https://cran.r-project.org/web/packages/ggmap/index.html" target="_blank">CRAN</a> is not current, you can install from Github.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">library</span>(devtools)</a>
<a class="sourceLine" id="cb5-2" title="2">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;dkahle/ggmap&quot;</span>, <span class="dt">ref =</span> <span class="st">&quot;tidyup&quot;</span>)</a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">library</span>(ggmap)</a></code></pre></div>
<p>As always, if you get error messages about a package already in use, restart R and try again.</p>
</div>
<h2 id="step-1.-tell-ggmap-your-api-key">Step 1. Tell <tt>ggmap</tt> your API Key</h2>
<p>Register your API key with <tt>ggmap::register_google()</tt>. This instructs ggmap to ‘remember’ your key and transmit it whenever needed for calls to the geocoding service.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">library</span>(ggmap)</a>
<a class="sourceLine" id="cb6-2" title="2">ggmap<span class="op">::</span><span class="kw">register_google</span>(<span class="dt">key =</span> mykey_google)</a></code></pre></div>
<h2 id="step-2.-geocode">Step 2. Geocode()</h2>
<p>You’re now ready to use the <tt>geocode()</tt> function. Start with something simple.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="co"># Geocode a city</span></a>
<a class="sourceLine" id="cb7-2" title="2">ggmap<span class="op">::</span><span class="kw">geocode</span>(<span class="st">&quot;San Francisco, CA&quot;</span>)</a></code></pre></div>
<pre><code>## [1] &quot;Source : https://maps.googleapis.com/maps/api/geocode/json?address=San%20Francisco%2C%20CA&amp;key=xxx-_jxqSpkCM_4TVw&quot;</code></pre>
<pre><code>##         lon      lat
## 1 -122.4194 37.77493</code></pre>
<div class="tryit">
<p>If you have a Google API Key, try it with i) a place name, ii) an address, and iii) a landmark.</p>
</div>
<h2 id="metadata-levels">Metadata Levels</h2>
<p>The Google Geocode API offers different levels of metadata with the geocoding results, which you can control by setting the <tt>output</tt> argument.</p>
<table class="tbl_compact">
<thead>
<tr>
<th style="text-align:left;">
output=
</th>
<th style="text-align:left;">
Returns
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
“latlon”
</td>
<td style="text-align:left;">
lat &amp; long
</td>
</tr>
<tr>
<td style="text-align:left;">
“latlona”
</td>
<td style="text-align:left;">
lat, long, &amp; address
</td>
</tr>
<tr>
<td style="text-align:left;">
“more”
</td>
<td style="text-align:left;">
lat, long, address, &amp; type of result (e.g., approximate, rooftop)
</td>
</tr>
</tbody>
</table>
<p>Compare the following:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">ggmap<span class="op">::</span><span class="kw">geocode</span>(<span class="st">&quot;City College Mission Campus, San Francisco, CA&quot;</span>, <span class="dt">output=</span><span class="st">&quot;latlona&quot;</span>)</a></code></pre></div>
<pre><code>##         lon      lat
## 1 -122.4206 37.75483
##                                                                 address
## 1 1125 valencia st., 4th floor,, san francisco, ca 94110, united states</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">ggmap<span class="op">::</span><span class="kw">geocode</span>(<span class="st">&quot;City College Mission Campus, San Francisco, CA&quot;</span>, <span class="dt">output=</span><span class="st">&quot;more&quot;</span>)</a></code></pre></div>
<pre><code>##         lon      lat          type          loctype
## 1 -122.4206 37.75483 establishment geometric_center
##                                                                 address
## 1 1125 valencia st., 4th floor,, san francisco, ca 94110, united states
##      north    south      east     west      locality
## 1 37.75618 37.75348 -122.4193 -122.422 San Francisco
##   administrative_area_level_1       country postal_code
## 1                  California United States       94110</code></pre>
<h2 id="geocoding-multiple-locations">Geocoding Multiple Locations</h2>
<p><tt>geocode()</tt> is vectorized, so you can pass it multiple locations and it will return a data frame with the matched results. If you want to add the lat-lon columns in the data frame (so you don’t have to merge them later) use <tt>ggmap::mutate_geocode()</tt>.</p>
</div>
<div id="example-geocode-california-breweries-with-google-maps" class="slide section level1">
<h1>Example: Geocode California Breweries with Google Maps</h1>
<p>First we import the <em>ca_breweries.csv</em> file.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">csv_fn &lt;-<span class="st"> &quot;../outputs/rspatial_scgis19/docs/data/ca_breweries.csv&quot;</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="kw">file.exists</span>(csv_fn)</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">cabrew_df &lt;-<span class="st"> </span><span class="kw">read.csv</span>(csv_fn, <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p>For now we’ll just work with the first 40 records.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">cabrew_df &lt;-<span class="st"> </span>cabrew_df[<span class="dv">1</span><span class="op">:</span><span class="dv">40</span>,]</a>
<a class="sourceLine" id="cb17-2" title="2"><span class="kw">head</span>(cabrew_df)</a></code></pre></div>
<pre><code>##                                   Name                     Address
## 1              10 Mile Brewing Company            1136 E Willow St
## 2                    101 North Brewing       1304 Scott St Suite D
## 3                           14 Cannons 31125 Via Colinas Suite 907
## 4 21st Amendment Brewery - San Leandro            2010 Williams St
## 5                2Kids Brewing Company         8680 Miralani Drive
## 6             32 North Brewing Company 8655 Production Ave Suite A
##               City State          Phone    Type
## 1      Signal Hill    CA (562) 612-1255 Brewery
## 2         Petaluma    CA (707) 778-8384 Brewery
## 3 Westlake Village    CA (818) 652-6971 Brewery
## 4      San Leandro    CA                Brewery
## 5        San Diego    CA (858) 480-5437 Brewery
## 6       Sand Diego    CA   619-363-2622 Brewery</code></pre>
<p>It looks like the addresses are split across the ‘Address’, ‘City’, and ‘State’ columns. Let’s combine those and add them to the data frame as a new column.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">fulladdr &lt;-<span class="st"> </span><span class="kw">paste</span>(cabrew_df<span class="op">$</span>Address, cabrew_df<span class="op">$</span>City, cabrew_df<span class="op">$</span>State, <span class="dt">sep=</span><span class="st">&quot;, &quot;</span>)</a>
<a class="sourceLine" id="cb19-2" title="2">fulladdr</a></code></pre></div>
<pre><code>##  [1] &quot;1136 E Willow St, Signal Hill, CA&quot;                
##  [2] &quot;1304 Scott St Suite D, Petaluma, CA&quot;              
##  [3] &quot;31125 Via Colinas Suite 907, Westlake Village, CA&quot;
##  [4] &quot;2010 Williams St, San Leandro, CA&quot;                
##  [5] &quot;8680 Miralani Drive, San Diego, CA&quot;               
##  [6] &quot;8655 Production Ave Suite A, Sand Diego, CA&quot;      
##  [7] &quot;1795 Hancock Street, San Diego, CA&quot;               
##  [8] &quot;821 Cornwall St, Cambria, CA&quot;                     
##  [9] &quot;2878 Columbia Street, Torrance, CA&quot;               
## [10] &quot;435 Fernleaf, Corona Del Mar, CA&quot;                 
## [11] &quot;1795 Hancock St., Suite P1, San Diego, CA&quot;        
## [12] &quot;28822 Old Town Front St., Temecula, CA&quot;           
## [13] &quot;975 Detroit Ave, Concord, CA&quot;                     
## [14] &quot;9368 Cabot Drive, San Diego, CA&quot;                  
## [15] &quot;692 Arrow Grand Cir, Covina, CA&quot;                  
## [16] &quot;2351 Alpine Blvd., Alpine, CA&quot;                    
## [17] &quot;2402 Research Drive, Livermore, CA&quot;               
## [18] &quot;9659 Main St, Plymouth, CA&quot;                       
## [19] &quot;4150 Mission Blvd #208, San Diego, CA&quot;            
## [20] &quot;336 South Anaheim Boulevard , Anaheim, CA&quot;        
## [21] &quot;1705 Mariposa St., San Francisco, CA&quot;             
## [22] &quot;17700 Highway 253, Boonville, CA&quot;                 
## [23] &quot;216 S Alameda St, Los Angeles, CA&quot;                
## [24] &quot;3101 Busch Dr., Fairfield, CA&quot;                    
## [25] &quot;15800 Roscoe Blvd, Van Nuys, CA&quot;                  
## [26] &quot;5621 Palmer Way, Carlsbad, CA&quot;                    
## [27] &quot;7123 Arlington Ave., Suite - A, Riverside, CA&quot;    
## [28] &quot;415 Grande Ave, South San Francisco, CA&quot;          
## [29] &quot;919 Calle Amanecer Suite A, San Clemente, CA&quot;     
## [30] &quot;3416 Adams Ave., San Diego, CA&quot;                   
## [31] &quot;2330 La Mirada Dr. Suite 300, Vista, CA&quot;          
## [32] &quot;401-B Bel Marin Keys Blvd, Novato, CA&quot;            
## [33] &quot;5401 Linda Vista Road, Suite 406, San Diego, CA&quot;  
## [34] &quot;10051 Old Grove Road Suite B, San Diego, CA&quot;      
## [35] &quot;950 Orcutt Rd, San Luis Obispo, CA&quot;               
## [36] &quot;1525 Cortland Ave, San Francisco, CA&quot;             
## [37] &quot;3535 N. Main St., Soquel, CA&quot;                     
## [38] &quot;2957 Randolph Ave, Unit B, Costa Mesa, CA&quot;        
## [39] &quot;2575 Pioneer Ave #104, Vista, CA&quot;                 
## [40] &quot;3055 Limestone Way, Paso Robles, CA&quot;</code></pre>
<p>Now we can run the geocode service. In order to add the coordinate columns to the existing data frame, we’ll use <tt>mutate_geocode()</tt> and save the result as a new data frame.</p>
<p><tt>mutate_geocode()</tt> requires the locations be saved in a column in the datqa frame, so we add that first.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">cabrew_df<span class="op">$</span>address_city_state &lt;-<span class="st"> </span>fulladdr</a>
<a class="sourceLine" id="cb21-2" title="2">cabrew_gc_df &lt;-<span class="st"> </span><span class="kw">mutate_geocode</span>(cabrew_df, address_city_state, <span class="dt">output=</span><span class="st">&quot;latlona&quot;</span>)</a>
<a class="sourceLine" id="cb21-3" title="3"><span class="kw">head</span>(cabrew_gc_df)</a></code></pre></div>
<p>If there are any addresses that did not yield a match, the coordinate columns will come back as <tt>NA</tt>. we can investigate them using an attribute filter.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">cabrew_gc_df[<span class="kw">is.na</span>(cabrew_gc_df<span class="op">$</span>lon),]</a></code></pre></div>
<pre><code>##  [1] Name               Address            City              
##  [4] State              Phone              Type              
##  [7] address_city_state lon                lat               
## [10] address           
## &lt;0 rows&gt; (or 0-length row.names)</code></pre>
<p>Plot the locations that geocoded successfully.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1"><span class="co">## Create a spatial points object</span></a>
<a class="sourceLine" id="cb24-2" title="2">cabrew_sp_ll &lt;-<span class="st"> </span>sp<span class="op">::</span><span class="kw">SpatialPoints</span>(cabrew_gc_df[<span class="op">!</span><span class="kw">is.na</span>(cabrew_gc_df<span class="op">$</span>lon),<span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>,<span class="st">&quot;lat&quot;</span>)], <span class="dt">proj4string =</span> <span class="kw">CRS</span>(<span class="st">&quot;+init=epsg:4326&quot;</span>))</a>
<a class="sourceLine" id="cb24-3" title="3"></a>
<a class="sourceLine" id="cb24-4" title="4"><span class="co">## Transform county boundaries boundaries into lat-long</span></a>
<a class="sourceLine" id="cb24-5" title="5">ca_counties_ll &lt;-<span class="st"> </span>sp<span class="op">::</span><span class="kw">spTransform</span>(ca_counties_alb, <span class="kw">CRS</span>(<span class="st">&quot;+init=epsg:4326&quot;</span>))</a>
<a class="sourceLine" id="cb24-6" title="6"></a>
<a class="sourceLine" id="cb24-7" title="7"><span class="co"># Plot</span></a>
<a class="sourceLine" id="cb24-8" title="8"><span class="kw">plot</span>(ca_counties_ll, <span class="dt">axes=</span>T, <span class="dt">asp=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb24-9" title="9"><span class="kw">plot</span>(cabrew_sp_ll, <span class="dt">pch=</span><span class="dv">18</span>, <span class="dt">col=</span><span class="st">&quot;purple&quot;</span>, <span class="dt">cex=</span><span class="fl">1.2</span>, <span class="dt">add=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="geocoding_files/figure-slidy/plot_brew_saved-1.png" width="768" style="display: block; margin: auto;" /></p>
<div class="info">
<p><strong>Other Things You Can Do with Geocode</strong></p>
<p><tt>revgeocode()</tt> performs a reverse geocode</p>
</div>
</div>
<div id="esri-world-geocoding-service" class="slide section level1">
<h1>ESRI World Geocoding Service</h1>
<p>If you have a Developer or an Organizational account with ESRI, you can use their Geocding API in R.</p>
<div class="tip">
<p>You can sign up for an account in the <a href="https://developers.arcgis.com/sign-up" target="_blank">ArcGIS Developer Program</a> for free. A free account will give you <a href="https://developers.arcgis.com/pricing/credits/" target="_blank">50 credits per month</a>. One geocode query consumes 0.04 credits, so that’s enough for ~1250 geocode queries / month.</p>
</div>
<h2 id="step-1.-create-a-project">Step 1. Create a Project</h2>
<p>ESRI calls an API key <em>tokens</em>. To get a token, you need to first create a Project.</p>
<p>After you log-in into the <a href="https://developers.arcgis.com/dashboard/" target="_blank">Dashboard</a>, click on ‘Applications’ then ‘New Application’. Fill in the short form that appears. ESRI requires you to enter at least one tag.</p>
<p>When your project is created, you’ll see your Client ID and Client Secret (long strings). Copy those. You’ll also get a Temporary Token, valid for about two hours. If two hours is long enough for you to do your work, you’re good to go and can skip the next step.</p>
<div class="info">
<p>For detailed instructions, see ESRI’s <a href="https://developers.arcgis.com/rest/geocode/api-reference/geocoding-authenticate-a-request.htm" target="_blank">API documentation</a></p>
</div>
<h2 id="generate-a-new-token">Generate a New Token</h2>
<p>If you need a token that is valid for more than two hours (the maximum is two weeks), copy-paste the following URL into notepad, then insert your Client ID and Client Scret strings into the placeholders.</p>
<p>
<textarea name="token_url_template-dashes" rows="4" cols="100">
&#104;ttps://www.arcgis.com/sharing/oauth2/token?client_id=your-client-id-here&grant_type=client_credentials&client_secret=your-client-secret-here&f=pjson&expiration=num-minutes-to-expire
</textarea>
</p>
<p>Replace <em>your-client-id-here</em> and <em>your-client-secret-here</em> with your ‘Client ID’ and ‘Client Secret’ string. Replace <em>num-minutes-to-expire</em> with the number of minutes before the token should expire. Note the maximum is 20160 (two weeks).</p>
<p>After you’ve edited the URL, copy it into your browser’s address bar and hit Enter. After a few seconds you’ll see a JSON object appear with your new token. It will look something like:</p>
<p>
<textarea name="token_url_json" rows="4" cols="100">
{
  "access_token": "nk1tIwBnYv3n9mrxE40Fy_lsN28sinvzQD-NyKuYNptMaLK99klZFXjTjzGn7OBc2FZSL6kRxPogwVL5RSzb6MB-Igto7jmIbfg7T3y6v8rQ..",
  "expires_in": 1209600
}
</textarea>
</p>
<p>The token is the long string between the quotes. Copy-paste it to your script, or better yet follow best practices and save it in an external file and read it into R programmatically (<a href="#(5)">see above</a>) .</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1">token_fn &lt;-<span class="st"> &quot;~/My Keys/esri-token.txt&quot;</span></a>
<a class="sourceLine" id="cb25-2" title="2">f &lt;-<span class="st"> </span><span class="kw">file</span>(token_fn, <span class="dt">open =</span> <span class="st">&quot;rt&quot;</span>)</a>
<a class="sourceLine" id="cb25-3" title="3">my_esri_token &lt;-<span class="st"> </span><span class="kw">readLines</span>(f, <span class="dt">n=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb25-4" title="4"><span class="kw">close</span>(f)</a></code></pre></div>
<h2 id="load-esri-geocoding-functions">Load ESRI Geocoding Functions</h2>
<p>There isn’t a R package for using the ESRI Geocoding Service, but thanks to <a href="https://github.com/cengel/ArcGIS_geocoding" target="_blank">Claudia Engel</a> and others there’s a script with two functions for geocoding with ESRI. To load these functions into R, source the script:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1"><span class="kw">source</span>(<span class="st">&#39;../outputs/rspatial_scgis19/docs/scripts/geocode_esri.R&#39;</span>)  <span class="co">## change path to the scripts folder you downloaded</span></a></code></pre></div>
<p>You should now have two additional functions you can use, <tt>geocode_one()</tt> and <tt>geocode_many()</tt>.</p>
<h2 id="geocode-a-single-address">Geocode a Single Address</h2>
<p>Like other geocoders, ESRI WGS can take place name or an address.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1"><span class="kw">geocode_one</span>(<span class="st">&quot;Millennium Tower, San Francisco, CA&quot;</span>, my_esri_token, <span class="dt">postal=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>##        lon      lat score locName status  matchAddr side addressType
## 1 -122.413 37.78679 89.66   World      M Millennium    L         POI</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1"><span class="kw">geocode_one</span>(<span class="st">&quot;547 Emerson St, Palo Alto, CA 94301&quot;</span>, my_esri_token, <span class="dt">postal=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>##         lon      lat score locName status
## 1 -122.1619 37.44418   100   World      M
##                                      matchAddr side  addressType
## 1 547 Emerson St, Palo Alto, California, 94301    R PointAddress</code></pre>
</div>
<div id="batch-geocode-multiple-addresses-with-esri-wgs" class="slide section level1">
<h1>Batch Geocode Multiple Addresses with ESRI WGS</h1>
<p>Let’s look at the arguments of the <tt>geocode_many()</tt> function.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" title="1"><span class="kw">args</span>(geocode_many)</a></code></pre></div>
<pre><code>## function (id, street, city, state, zip, token) 
## NULL</code></pre>
<div class="info">
<p><strong><tt>geocode_many()</tt> usage</strong></p>
<div class="indented1">
<ul>
<li><tt>geocode_many(id, street, city, state, zip, token)</tt></li>
<li><tt>id</tt> should be a numeric vector with unique values. This will be returned in the ouptut as column ‘ID’ so you can merge the lat and lon columns into the original data frame.</li>
<li>Unlike <tt>geocode_one()</tt>, the addresses must be split up into <tt>street</tt>, <tt>city</tt>, <tt>state</tt>, and <tt>zip</tt>. This is how ESRI requires the data and makes the process more efficient (i.e., they don’t have to try to unpack an address string).</li>
<li>Only 1,000 addresses can be geocoded at a time. If you have more than that, you have to break it up into chunks.</li>
</ul>
</div>
</div>
<h2 id="example-geocode-san-francisco-libraries">Example: Geocode San Francisco Libraries</h2>
<p><strong>Step 1. Load the csv file</strong></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1">csv_fn &lt;-<span class="st"> &quot;../outputs/rspatial_scgis19/docs/data/sf_libraries.csv&quot;</span>; <span class="kw">file.exists</span>(csv_fn)</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" title="1">sflib_df &lt;-<span class="st"> </span><span class="kw">read.csv</span>(csv_fn, <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb35-2" title="2"><span class="kw">str</span>(sflib_df)</a></code></pre></div>
<pre><code>## &#39;data.frame&#39;:    28 obs. of  6 variables:
##  $ branch   : chr  &quot;ANZA&quot; &quot;BAYVIEW / LINDA BROOKS-BURTON&quot; &quot;BERNAL HEIGHTS&quot; &quot;CHINATOWN / HIM MARK LAI&quot; ...
##  $ phone.num: chr  &quot; (415) 355-5717&quot; &quot; (415) 355-5757&quot; &quot; (415) 355-2810&quot; &quot; (415) 355-2888&quot; ...
##  $ address  : chr  &quot; 550 37th Ave.&quot; &quot; 5075 Third St.&quot; &quot; 500 Cortland Ave.&quot; &quot; 1135 Powell St.&quot; ...
##  $ city     : chr  &quot; San Francisco&quot; &quot; San Francisco&quot; &quot; San Francisco&quot; &quot; San Francisco&quot; ...
##  $ state    : chr  &quot; CA&quot; &quot; CA&quot; &quot; CA&quot; &quot; CA&quot; ...
##  $ zip      : int  94121 94124 94110 94108 94114 94112 94131 94123 94112 94102 ...</code></pre>
<p><strong>Step 2: Inspect the columns</strong></p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" title="1"><span class="kw">head</span>(sflib_df)</a></code></pre></div>
<pre><code>##                                 branch       phone.num
## 1                                 ANZA  (415) 355-5717
## 2        BAYVIEW / LINDA BROOKS-BURTON  (415) 355-5757
## 3                       BERNAL HEIGHTS  (415) 355-2810
## 4             CHINATOWN / HIM MARK LAI  (415) 355-2888
## 5 EUREKA VALLEY / HARVEY MILK MEMORIAL  (415) 355-5616
## 6                            EXCELSIOR  (415) 355-2868
##                address           city state   zip
## 1        550 37th Ave.  San Francisco    CA 94121
## 2       5075 Third St.  San Francisco    CA 94124
## 3    500 Cortland Ave.  San Francisco    CA 94110
## 4      1135 Powell St.  San Francisco    CA 94108
## 5  1 Jose Sarria Court  San Francisco    CA 94114
## 6     4400 Mission St.  San Francisco    CA 94112</code></pre>
<p>The address, city, and zip columns look pretty good, but the data frame doesn’t have an ‘ID’ column which geocode_many() requires. Let’s add that now.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" title="1">sflib_df<span class="op">$</span>ID &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(sflib_df)</a></code></pre></div>
<p>Note how we made ID capitalized. That’s because the ID column in the results is capitalized, so this will make it easier to merge the new columns with the original.</p>
<p>Now we’re ready to geocode:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" title="1">sflib_gc_esri &lt;-<span class="st"> </span><span class="kw">geocode_many</span>(sflib_df<span class="op">$</span>ID, sflib_df<span class="op">$</span>address, sflib_df<span class="op">$</span>city, sflib_df<span class="op">$</span>state, sflib_df<span class="op">$</span>zip, my_esri_token)</a>
<a class="sourceLine" id="cb40-2" title="2"><span class="kw">head</span>(sflib_gc_esri)</a></code></pre></div>
<pre><code>##   ID       lon      lat score locName status
## 1  2 -122.3914 37.73254   100   World      M
## 2  4 -122.4098 37.79525   100   World      M
## 3  1 -122.4975 37.77852   100   World      M
## 4  3 -122.4160 37.73899   100   World      M
## 5 19 -122.4511 37.77040   100   World      M
## 6  9 -122.4562 37.72394   100   World      M
##                                            matchAddr side  addressType
## 1      5075 3rd St, San Francisco, California, 94124    R PointAddress
## 2   1135 Powell St, San Francisco, California, 94108    L PointAddress
## 3     550 37th Ave, San Francisco, California, 94121    R PointAddress
## 4 500 Cortland Ave, San Francisco, California, 94110    L PointAddress
## 5     1833 Page St, San Francisco, California, 94117    R PointAddress
## 6   1298 Ocean Ave, San Francisco, California, 94112    R PointAddress</code></pre>
<p>That looks pretty good. Let’s merge the new columns back into the original. This is easy because both the results and the original data frame have a numeric column ID that we can use to match the records.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" title="1">sflib_loc_df &lt;-<span class="st"> </span><span class="kw">merge</span>(sflib_df, sflib_gc_esri, <span class="dt">by =</span> <span class="st">&quot;ID&quot;</span>, <span class="dt">all.x =</span> T)</a>
<a class="sourceLine" id="cb42-2" title="2"><span class="kw">head</span>(sflib_loc_df)</a></code></pre></div>
<pre><code>##   ID                               branch       phone.num
## 1  1                                 ANZA  (415) 355-5717
## 2  2        BAYVIEW / LINDA BROOKS-BURTON  (415) 355-5757
## 3  3                       BERNAL HEIGHTS  (415) 355-2810
## 4  4             CHINATOWN / HIM MARK LAI  (415) 355-2888
## 5  5 EUREKA VALLEY / HARVEY MILK MEMORIAL  (415) 355-5616
## 6  6                            EXCELSIOR  (415) 355-2868
##                address           city state   zip       lon      lat score
## 1        550 37th Ave.  San Francisco    CA 94121 -122.4975 37.77852   100
## 2       5075 Third St.  San Francisco    CA 94124 -122.3914 37.73254   100
## 3    500 Cortland Ave.  San Francisco    CA 94110 -122.4160 37.73899   100
## 4      1135 Powell St.  San Francisco    CA 94108 -122.4098 37.79525   100
## 5  1 Jose Sarria Court  San Francisco    CA 94114 -122.4318 37.76423   100
## 6     4400 Mission St.  San Francisco    CA 94112 -122.4331 37.72697   100
##   locName status                                          matchAddr side
## 1   World      M     550 37th Ave, San Francisco, California, 94121    R
## 2   World      M      5075 3rd St, San Francisco, California, 94124    R
## 3   World      M 500 Cortland Ave, San Francisco, California, 94110    L
## 4   World      M   1135 Powell St, San Francisco, California, 94108    L
## 5   World      M 1 Jose Sarria Ct, San Francisco, California, 94114    R
## 6   World      M  4400 Mission St, San Francisco, California, 94112    L
##     addressType
## 1  PointAddress
## 2  PointAddress
## 3  PointAddress
## 4  PointAddress
## 5 StreetAddress
## 6  PointAddress</code></pre>
<p>To plot these, we can turn it into a <tt>SpatialPointsDataFrame</tt>.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" title="1">coord_cols &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</a>
<a class="sourceLine" id="cb44-2" title="2">attribute_tbl_cols &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;branch&quot;</span>, <span class="st">&quot;phone.num&quot;</span>, <span class="st">&quot;address&quot;</span>, <span class="st">&quot;city&quot;</span>, <span class="st">&quot;state&quot;</span>, <span class="st">&quot;zip&quot;</span>, <span class="st">&quot;matchAddr&quot;</span>)</a>
<a class="sourceLine" id="cb44-3" title="3">sflib_spdf &lt;-<span class="st"> </span><span class="kw">SpatialPointsDataFrame</span>(<span class="dt">coords =</span> sflib_loc_df[, coord_cols],</a>
<a class="sourceLine" id="cb44-4" title="4">                                     <span class="dt">data  =</span> sflib_loc_df[, attribute_tbl_cols],</a>
<a class="sourceLine" id="cb44-5" title="5">                                     <span class="dt">proj4string =</span> <span class="kw">CRS</span>(<span class="st">&quot;+init=epsg:4326&quot;</span>))</a>
<a class="sourceLine" id="cb44-6" title="6"><span class="kw">plot</span>(sfnb_ll, <span class="dt">axes=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb44-7" title="7"><span class="kw">plot</span>(sflib_spdf, <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">pch=</span><span class="dv">16</span>, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)</a></code></pre></div>
<p><img src="geocoding_files/figure-slidy/plot_sflib_gc_spdf-1.png" width="768" style="display: block; margin: auto;" /></p>
</div>
<div id="geocode-with-osm-nominatim" class="slide section level1">
<h1>Geocode with OSM Nominatim</h1>
<p>Nominatim is the geocoding service from Open Street Map. It’s main purporse is to power the ‘search’ tools on various OSM products, but the developers have also opened up the API for the open source community.</p>
<p>OSM Nominatim does not require an API Key, but to control overuse it restricts searches to 1 per second. Excessive use could result in other restrictions, so if you have a big job it would be best to contact them. See also the <a href="http://wiki.openstreetmap.org/wiki/Nominatim_usage_policy" target="_blank">Nominatim Usage Policy</a></p>
<h2 id="geocoding-with-tmaptools">Geocoding with <tt>tmaptools</tt></h2>
<p>There are a couple of R packages that have functions that work with OSM Nominatim. One of them is <tt>tmaptools</tt>. The latest version is on github:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" title="1"><span class="kw">library</span>(devtools)</a>
<a class="sourceLine" id="cb45-2" title="2">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;mtennekes/tmaptools&quot;</span>)</a></code></pre></div>
<p>The OSM geocoding function in <tt>tmaptools</tt> is <tt>geocode_OSM()</tt>.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" title="1">tmaptools<span class="op">::</span><span class="kw">geocode_OSM</span>(<span class="dt">q=</span><span class="st">&quot;2090 Kittredge St., Berkeley, CA 94704&quot;</span>)</a></code></pre></div>
<pre><code>## $query
## [1] &quot;2090 Kittredge St., Berkeley, CA 94704&quot;
## 
## $coords
##          x          y 
## -122.26890   37.86795 
## 
## $bbox
##       xmin       ymin       xmax       ymax 
## -122.26918   37.86757 -122.26813   37.86835</code></pre>
<p><tt>geocode_OSM()</tt> is vectorized so you can feed it multiple locations. Remember however the one-search-per-second limit.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" title="1">berkeley_lib_addr &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2090 Kittredge St., Berkeley, CA 94704&quot;</span>, </a>
<a class="sourceLine" id="cb48-2" title="2">                       <span class="st">&quot;2940 Benvenue Ave., Berkeley, CA 94705&quot;</span>, </a>
<a class="sourceLine" id="cb48-3" title="3">                       <span class="st">&quot;1170 The Alameda, Berkeley, CA 94707&quot;</span>, </a>
<a class="sourceLine" id="cb48-4" title="4">                       <span class="st">&quot;1901 Russell St., Berkeley, CA 94703&quot;</span>, </a>
<a class="sourceLine" id="cb48-5" title="5">                       <span class="st">&quot;1125 University Ave., Berkeley, CA 94702&quot;</span>)</a>
<a class="sourceLine" id="cb48-6" title="6">berkeley_lib_gc &lt;-<span class="st"> </span>tmaptools<span class="op">::</span><span class="kw">geocode_OSM</span>(<span class="dt">q=</span>berkeley_lib_addr, <span class="dt">as.data.frame=</span><span class="ot">TRUE</span>) </a>
<a class="sourceLine" id="cb48-7" title="7">berkeley_lib_gc</a></code></pre></div>
<pre><code>##                                      query      lat       lon  lat_min
## 1   2090 Kittredge St., Berkeley, CA 94704 37.86795 -122.2689 37.86757
## 2   2940 Benvenue Ave., Berkeley, CA 94705 37.85672 -122.2544 37.85666
## 3     1170 The Alameda, Berkeley, CA 94707 37.88543 -122.2754 37.88525
## 4     1901 Russell St., Berkeley, CA 94703 37.85650 -122.2710 37.85643
## 5 1125 University Ave., Berkeley, CA 94702 37.86950 -122.2910 37.86938
##    lat_max   lon_min   lon_max
## 1 37.86835 -122.2692 -122.2681
## 2 37.85677 -122.2544 -122.2543
## 3 37.88564 -122.2755 -122.2753
## 4 37.85658 -122.2711 -122.2708
## 5 37.86972 -122.2911 -122.2908</code></pre>
<p>OSM is a volunteer driven effort, so the quality and completeness of the data varies. In some places it is as good as and frequently better than commercial products from ESRI or Google. In other places, address locations may be thin. You can check the results for your area before processing a large number of queries.</p>
</div>
<div id="additional-resources" class="slide section level1">
<h1>Additional Resources</h1>
<div class="compact indented1">
<ul>
<li><a href="https://github.com/dlab-geo/geocoding" target="_blank">Intro to Geocoding</a>, Patty Frontiera</li>
<li><a href="https://github.com/dlab-geo/RGeocoding" target="_blank">Geocoding in R</a>, Patty Frontiera</li>
<li><a href="http://www.rpubs.com/cengel248/177198" target="_blank">Geocoding in R</a>, Claudia Engel</li>
<li><a href="https://github.com/cengel/r_IPgeocode" target="_blank">Geocoding IP addresses</a>, Claudia Engel</li>
<li><em>ggmap</em> Vignette</li>
</ul>
</div>
</div>

  <!-- dynamically load mathjax for compatibility with self-contained -->
  <script>
    (function () {
      var script = document.createElement("script");
      script.type = "text/javascript";
      script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
      document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>

</body>
</html>
